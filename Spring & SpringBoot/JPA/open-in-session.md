# JPA open-in-view
JPA의 open-in-view 옵션을 잘 이해하고 사용하자.

<br/>

## OSIV
- Open Session In View
- 영속성 컨텍스트를 View까지 열어두는 기능
- 영속성 컨텍스트가 유지되면 엔티티도 영속 상태로 유지됨.  
  즉, View 에서도 지연 로딩을 사용할 수 있음.

### Spring OSIV 동작 원리
- 비즈니스 계층 트랜잭션  
  `open-in-view = true`

  ![Spring OSIV ON](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fbd835C%2FbtqTPzbjhqa%2FAPhn7gWwr4pRhzCL79N4q1%2Fimg.png)

- 동작 원리
1. 클라이언트의 요청이 들어오면 서블릿 필터나, 스프링 인터셉터에서 영속성 컨텍스트를 생성한다.
2. 서비스 계층에서 `@Transactional`로 트랜잭션을 시작할 때 1번에서 미리 생성해둔 영속성 컨텍스트를 찾아와서 트랜잭션을 시작한다.
3. 서비스 계층이 끝나면 트랜잭션을 커밋하고 영속성 컨텍스트를 플러시한다. 이 시점에 트랜잭션은 끝내지만 영속성 컨텍스트는 종료되지 않는다.
4. 컨트롤러와 뷰까지 영속성 컨텍스트가 유지되므로 조회한 엔티티는 영속 상태를 유지한다.
5. 서블릿 필터나, 스프링 인터셉터로 요청이 돌아오면 영속성 컨텍스트를 종료한다. 이때 플러시를 호출하지 않고 바로 종료한다.

서비스 계층에서 트랜잭션이 끝나면 컨트롤러와 뷰에는 트랜잭션이 유지되지 않지만, 엔티티의 단순 조회는 가능하다.  
단, 트랜잭션 밖에서의 엔티티 수정은 동작하지 않는다.

### OSIV 전략 주의사항
OSIV 전략은 최초 데이터베이스 커넥션 시작 시점부터 API 응답이 끝날 때 까지 영속성 컨텍스트와 데이터베이스 커넥션을 유지한다. 그래서 View Template이나 API 컨트롤러에서 지연 로딩이 가능하다. 이것이 장점이자 단점이 된다.

너무 오랜시간동안 데이터베이스 커넥션 리소스를 사용하기 때문에, 실시간 트래픽이 중요한 애플리케이션에서는 커넥션이 모자라 장애로 이어질 수 있다.  
예를 들어 컨트롤러에서 외부 API를 호출하면 외부 API 대기시간 만큼 커넥션 리소스를 반환하지 못하고 유지해야 한다.

- `open-in-view = false`

  ![Spring OSIV OFF](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FemsRZ9%2FbtqTLyKOQQ7%2F5cKM4Ma00A7LYKwhde77Zk%2Fimg.png)

OSIV를 끄면 트랜잭션을 종료할 때 영속성 컨텍스트를 닫고, 데이터베이스 커넥션도 반환한다. 따라서 커넥션 리소스를 낭비하지 않는다.

OSIV를 끄면 모든 지연로딩을 트랜잭션 안에서 처리해야 한다. 따라서 지금까지 작성한 많은 지연 로딩 코드를 트랜잭션 안으로 넣어 트랜잭션이 끝나기 전에 지연 로딩을 강제로 호출해 두어야 한다는 단점이 있다.

<br/>

## OSIV 내용 정리
- 특징
  - OSIV는 클라이언트 요청이 들어올 때 영속성 컨텍스트를 생성해서 요청이 끝날 때까지 같은 영속성 컨텍스트를 유지함
  - 한 번 조회된 엔티티는 요청이 끝날 때까지 영속 상태를 유지
  - 엔티티 수정은 트랜잭션이 있는 계층에서만 동작
  - 트랜잭션이 없는 프레젠테이션 계층은 지연 로딩을 포함해 조회만 가능
- 단점
  - 영속성 컨텍스트와 DB 커넥션은 1:1로 물고있는 관계이기 때문에 프레젠테이션 로직까지 DB 커넥션 자원을 낭비하게 됨
  - OSIV를 적용하면 같은 영속성 컨텍스트를 여러 트랜잭션이 공유하게 될 수 있음  
프레젠테이션 계층에서 엔티티를 수정하고 비즈니스 로직을 수행하면 엔티티가 수정될 수 있음
  - 프레젠테이션 계층에서 지연 로딩에 의해 SQL이 실행되기 때문에 성능 튜닝시 확인해야 할 부분이 넓어짐

<br/>

## References
- [ykh6242.tistory.com/102](https://ykh6242.tistory.com/102)